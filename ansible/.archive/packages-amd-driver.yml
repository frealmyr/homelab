---
- hosts: localhost
  become: yes
  vars:
    - target_package: amdgpu-install
    - target_url: https://repo.radeon.com/amdgpu-install/latest/ubuntu/focal/amdgpu-install-21.40.40500-1_all.deb
  tasks:
    - name: Check if {{ target_package }} is installed
      command: dpkg-query -W target_package
      register: target_package_check_deb
      failed_when: target_package_check_deb.rc > 1
      changed_when: target_package_check_deb.rc == 1

    - name: Download {{ target_package }}
      get_url:
        url="{{ target_url }}"
        dest="/tmp/{{ target_package }}.deb"
      when: target_package_check_deb.rc == 1

    - name: Install {{ target_package }}
      apt: deb="/tmp/{{ target_package }}.deb"
      when: target_package_check_deb.rc == 1

    - name: Delete {{ target_package }} leftovers
      ansible.builtin.file:
        path: /tmp/{{ target_package }}.deb
        state: absent

    - name: update apt packages
      apt:
        upgrade: full
        update_cache: yes

    - name: run amdgpu-install script
      command: amdgpu-install -y --accept-eula
