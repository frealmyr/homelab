---
- hosts: private, public
  become: true
  vars:
    subnet_pod: 10.244.0.0/16
    subnet_svc: 10.122.0.0/16

  tasks:
    - name: firewall - reset firewall to installation defaults
      community.general.ufw:
        state: reset

    #########
    ## LAN ##
    #########

    - name: firewall - allow ssh from LAN and VPN
      community.general.ufw:
        rule: limit
        src: '192.168.0.0/15'
        port: '22'
        proto: tcp

    - name: firewall - allow ingress ports from LAN and VPN
      community.general.ufw:
        rule: allow
        src: 192.168.0.0/15
        port: "{{ item }}"
        proto: tcp
      loop:
        - '80'
        - '443'
        - '8080'
        - '8443'

    # ############
    # ## Public ##
    # ############

    - name: firewall - allow ingress ports to worker-1
      community.general.ufw:
        rule: allow
        direction: in
        port: "{{ item }}"
        proto: tcp
      loop:
        - '80'
        - '443'
      when: "'public' in inventory_hostname"

    - name: firewall - allow wireguard ingress to worker-1
      community.general.ufw:
        rule: allow
        direction: in
        port: '51820'
        proto: udp
      when: "'public' in inventory_hostname"

    ############
    ## Global ##
    ############

    - name: firewall - allow outgoing
      community.general.ufw:
        direction: outgoing
        policy: allow

    - name: firewall - deny incoming
      community.general.ufw:
        direction: incoming
        policy: deny

    - name: firewall - reload and enable firewall on boot
      community.general.ufw:
        state: disabled
