---
- hosts: k8s_controller, k8s_workers
  become: true
  max_fail_percentage: 0 # Stop if checks.yml fails
  tasks:
    ##################
    ## RPM Packages ##
    ##################

    - name: dnf - upgrade latest
      dnf:
        name: "*"
        update_cache: true
        state: latest

    - name: dnf - remove default packages
      dnf:
        name:
          - zram-generator
          - zram-generator-defaults
        state: absent

    - name: dnf - install system packages
      dnf:
        name:
          - cronie
          - nut-client
          - tuned

    - name: dnf - install k8s prerequisites
      dnf:
        name:
          - cri-o
          - cri-tools
          - iscsi-initiator-utils
          - iproute-tc
          - nfs-utils

    - name: yum - add kubernetes repository
      ansible.builtin.yum_repository:
        name: Kubernetes
        description: Kubernetes
        baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch
        enabled: true
        gpgcheck: true
        gpgkey: https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
        exclude: kubelet kubeadm kubectl

    # Kubernetes packages should not be upgraded out of sync with a cluster upgrade using kubeadm.
    # Therefore, use state present and upgrade packages manually during kubeadm upgrade.
    # https://github.com/kubernetes/kubeadm/issues/954
    - name: yum - install kubernetes packages
      ansible.builtin.yum:
        name:
          - kubeadm
          - kubectl
          - kubelet
        disable_excludes: Kubernetes
        update_cache: true
        state: present
