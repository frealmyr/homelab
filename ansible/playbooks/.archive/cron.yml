---
- hosts: server_debian
  become: true

  tasks:

    - name: prometheus - copy files to node
      copy: src={{ item.src }} dest={{ item.dest }}
      with_items:
        - { src: './files/smartmontools/nvme_metrics.sh', dest: '/usr/local/bin/nvme_metrics.sh' }
        - { src: './files/smartmontools/smartmon.sh', dest: '/usr/local/bin/smartmon.sh' }
        - { src: './files/systemd/node-exporter-folder.service', dest: '/etc/systemd/system/node-exporter-folder.service' }

    - name: prometheus - create /tmp/prometheus_collector folder on boot
      ansible.builtin.systemd:
        name: node-exporter-folder.service
        state: started
        enabled: yes

    - name: prometheus - create script cron jobs
      ansible.builtin.cron:
        name: "{{ item.name }}"
        weekday: "*"
        minute: "*/1"
        hour: "*"
        user: root
        job: "{{ item.job }}"
        cron_file: "{{ item.cron_file }}"
      with_items:
        - { name: 'nvme_metrics', job: '/bin/bash /usr/local/bin/nvme_metrics.sh > /tmp/prometheus_collector/nvme_metrics.prom', cron_file: 'nvme_metrics' }
        - { name: 'smartmon', job: '/bin/bash /usr/local/bin/smartmon.sh > /tmp/prometheus_collector/smartmon.prom', cron_file: 'smartmon' }
