---
- hosts: k8s_master, k8s_workers
  become: true
  vars:
    subnet_pod: 10.244.0.0/16
    subnet_svc: 10.122.0.0/16

  tasks:
    - name: firewall - reset firewall to installation defaults
      community.general.ufw:
        state: reset

    #########
    ## LAN ##
    #########

    - name: firewall - allow ssh from LAN
      community.general.ufw:
        rule: limit
        src: 10.0.0.0/24
        port: 22
        proto: tcp

    - name: firewall - allow ingress ports from LAN
      community.general.ufw:
        rule: allow
        src: 10.0.0.0/24
        port: "{{ item }}"
        proto: tcp
      loop:
        - 80
        - 443
        - 8080
        - 8443

    - name: firewall - allow kubectl access to controller from LAN
      community.general.ufw:
        rule: allow
        src: 10.0.0.0/24
        port: 6443
        proto: tcp
      when: "'k8s_master' in group_names"

    ################
    ## Kubernetes ##
    ################

    # K8s nodes are running in a seperate VLAN
    # NetworkPolicies are used for in-cluster firewall

    - name: firewall - allow all traffic between nodes
      community.general.ufw:
        rule: allow
        src: "{{ item }}"
      loop:
        - "{{ subnet_pod }}"
        - "{{ subnet_svc }}"
        - 10.8.0.0/24 # K8s VLAN

    ############
    ## Global ##
    ############

    - name: firewall - allow outgoing
      community.general.ufw:
        direction: outgoing
        policy: allow

    - name: firewall - deny incoming
      community.general.ufw:
        direction: incoming
        policy: deny

    - name: firewall - reload and enable firewall on boot
      community.general.ufw:
        state: enabled
