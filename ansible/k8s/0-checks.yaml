---
- hosts: localhost
  become: true
  vars:
    local_user: fredrick

  tasks:
    - name: checks - ensure access to google secret manager
      shell: gcloud secrets describe homelab-apps
      delegate_to: localhost
      become_user: "{{ local_user }}"
      register: gcpsm_upload_kubectl_output

    - name: ssh - remove known_hosts entries
      shell: ssh-keygen -R "{{ hostvars[item].ansible_host }}"
      with_items: "{{ groups['k8s'] }}"
      delegate_to: localhost
      become_user: "{{ local_user }}"
      when: gcpsm_upload_kubectl_output.rc == 0

    - name: ssh - add known_hosts entries
      shell: ssh-keyscan -H "{{ hostvars[item].ansible_host }}" >> ~/.ssh/known_hosts
      with_items: "{{ groups['k8s'] }}"
      delegate_to: localhost
      become_user: "{{ local_user }}"
      when: gcpsm_upload_kubectl_output.rc == 0
