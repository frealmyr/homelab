app:
  image:
    repository: viktorstrate/photoview
    tag: 2.3.13

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - k8s-worker-0

  persistentVolumes:
    static:
      - name: cache
        mountPath: /app/cache
      - name: sqlite
        mountPath: /app/database
    nfs:
      - name: gallery
        server: 10.7.0.11
        remotePath: /gallery
        mountPath: /app/gallery

  environmentVariables:
    PHOTOVIEW_LISTEN_IP: 0.0.0.0
    PHOTOVIEW_LISTEN_PORT: 80
    PHOTOVIEW_DATABASE_DRIVER: sqlite
    PHOTOVIEW_MEDIA_CACHE: /app/cache
    PHOTOVIEW_SQLITE_PATH: /app/database/photoview.db

  secretEnvironmentVariables:
    - name: MAPBOX_TOKEN
      secret:
        name: credentials-app
        key: mapbox-token

  additionalContainers:
    - name: cloudflare-tunnel
      image:
        repository: milgradesec/cloudflared
        tag: latest
      command:
        - /usr/local/bin/cloudflared
        - '--no-autoupdate'
        - tunnel
        - run
      secretEnvironmentVariables:
        - name: TUNNEL_TOKEN
          secret:
            name: credentials-cloudflare-tunnel
            key: token

  containerPorts:
    - name: http
      containerPort: 8080
      protocol: TCP

  services:
    - name: http
      type: ClusterIP
      ports:
        - name: http
          port: 8080
          targetPort: 8080

  ingresses:
    enabled: true
    ingress:
      - name: frontend
        service:
          name: http
          port: 8080
        hosts:
          - host: photos2.fmlab.no
            paths:
              - path: /
                pathType: ImplementationSpecific
        tls:
          - secretName: photoview
            hosts:
              - photos2.fmlab.no
