---
- hosts: all
  become: true
  tasks:
    - name: update apt packages
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: upgrade apt packages
      apt:
        upgrade: full

    - name: clean & remove apt packages
      apt:
        autoclean: yes
        autoremove: yes
    
    - name: disable swap
      command: swapoff -a  

    - name: download k3s script
      get_url:
        url: https://get.k3s.io
        dest: /home/vagrant/install-k3s.sh
      register: k3s_script
    
    - name: install k3s
      shell: K3S_KUBECONFIG_MODE='644' INSTALL_K3S_EXEC='--no-deploy traefik --disable servicelb' INSTALL_K3S_VERSION='{{ k3s_version }}' sh {{ k3s_script.dest }}
    
    - name: verify k3s install
      shell: k3s check-config
      register: k3s_check_output

    - name: Pass kubectl content in a variable
      command: cat /etc/rancher/k3s/k3s.yaml
      register: kubectl_copy

    - name: Create Terraform directory if it does not exist
      local_action: shell mkdir .terraform
      become_user: "{{ host_username }}"

    - name: Copy kubeconfig to Terraform directory
      local_action: copy content={{ kubectl_copy.stdout }} dest=../.terraform/kubeconfig
      become_user: "{{ host_username }}"
